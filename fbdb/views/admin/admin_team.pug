extends ../layout

block content
    .container
        .mb-5.mt-5
            legend(data-toggle="collapse" data-target="#addForm") Add team (click to expand)
            form#addForm.collapse
                .form-group.row
                    label.col-sm-2.col-form-label(for="addName") Team name
                    .col-sm-10
                        input#addName.form-control(type="text" placeholder="Team name" required)
                .form-group.row
                    label.col-sm-2.col-form-label(for="addFoundation") Foundation
                    .col-sm-10
                        input#addFoundation.form-control(type="number" placeholder="Foundation" required)
                .form-group.row
                    label.col-sm-2.col-form-label(for="addStadium") Stadium
                    .col-sm-10
                        input#addStadium.form-control(type="text" placeholder="Stadium" required)
                .form-group.row
                    .col-sm-2(for="addLogo") Logo
                    .col-sm-10
                        .custom-file
                            input#addLogo.custom-file-input(type='file' name='addLogo' accept='image/*')
                            label.custom-file-label Choose file
                .form-group.row
                    label.col-sm-2.col-form-label(for="addColor1") Color 1
                    .col-sm-10
                        input#addColor1.form-control(type="color")
                .form-group.row
                    label.col-sm-2.col-form-label(for="addColor2") Color 2
                    .col-sm-10
                        input#addColor2.form-control(type="color")
                .form-group.row
                    label.col-sm-2.col-form-label(for="addLeague" required) League
                    .col-sm-10
                        select#addLeague.form-control
                .row
                    .col-sm-2
                    .col-sm-10
                         button#btnAdd.btn.btn-success(type='button') Add

        h3 Teams
        table#teamTable.table.table-hover
            caption Click on teams to update/delete
            thead.thead-dark
                tr
                    th ID
                    th Team
                    th Foundation
                    th Stadium
                    th Logo
                    th Color 1
                    th Color 2
                    th League
            tbody#teamTableBody    

    script(type='text/javascript').
        $(document).ready(function(){
            populateSelect();
            populateTable();

            $("#btnAdd").on('click', function(){
                if (!$("#addLogo")[0].files[0]) {
                    toastr.error('Image can\'t be empty.')
                    return;
                }

                var reader = new FileReader();
                reader.readAsDataURL($("#addLogo")[0].files[0]);
                reader.onload = function (readerEvt) {
                    var binaryString = readerEvt.target.result;      
                    var newTeam = {
                        name: $("#addName").val(),
                        foundation: $("#addFoundation").val(),
                        stadium: $("#addStadium").val(),
                        logo: binaryString,
                        color1: $("#addColor1").val(),
                        color2: $("#addColor2").val(),
                        league: $("#addLeague").val()
                    }

                    // Check if any property is empty
                    for (var key in newTeam) {
                        if (newTeam[key] == null || newTeam[key] == '') {
                            toastr.error('All values must be filled in the form...');
                            return;
                        }
                    }

                    $.ajax({
                        type: 'POST',
                        url: '/api/teams',
                        data: newTeam,
                        dataType: 'json',
                        success: function(data){
                            toastr.success('Team added successfully!');
                            populateTable(); //refresh
                            document.getElementById("addForm").reset(); //reset
                        },
                        error: function(data){
                            toastr.error('Error while adding country...');
                        }
                    }); 
                };        
            });
        });
        
        // Add leauges to select inputs
        function populateSelect(){
            $.ajax({
                type: 'GET',
                url: '/api/leagues',
                dataType: 'json',
                success: function(data){
                    for(let i=0; i<data.length; i++) {
                        var option1 = new Option(data[i].l_name, data[i].l_id);
                        var option2 = new Option(data[i].l_name, data[i].l_id);
                        $(option1).html(data[i].l_name);
                        $(option2).html(data[i].l_name);
                        $("#addLeague").append(option1);
                        //$("#leagueSelectCountryModal").append(option2);
                    }
                },
                error: function(data){
                    toastr.error('Error while fetching leagues...');
                }
            })
        }

        // Populate teams table
        function populateTable(){
            $.ajax({
                type: 'GET',
                url: '/api/teams',
                dataType: 'json',
                success: function(data){
                    $("#teamTableBody").empty(); // clear table
                    for(var i=0; i<data.length; i++){
                        // get league info
                        var url = '/api/leagues/' + data[i].l_id;
                        $.ajax({
                            type: 'GET', 
                            url: url,
                            success: function(league) {
                                var row = `
                                    <tr class='rowLeague' id='${data.t_id}'>
                                        <td>${data[i].t_id}</td>
                                        <td>${data[i].t_name}</td>
                                        <td>${data[i].t_year}</td>
                                        <td>${data[i].t_stadium}</td>
                                        <td><img height='48' src='${data[i].t_logo}'></td>
                                        <td bgcolor='${data[i].t_color1}'></td>
                                        <<td bgcolor='${data[i].t_color2}'></td>
                                        <td>${league.l_name}</td>
                                    </tr>"
                                `;
                                $("#teamTableBody").append(row);
                            }
                        });

                        
                    }
                },
                error: function(data){
                    toastr.error('Error while fetching leagues...')
                }
            });
        }
        